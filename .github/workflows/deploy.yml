name: Deploy with API_URL Replacement

on:
  push:
    branches:
      - main  # åªåœ¨ main åˆ†æ”¯æ¨é€æ™‚åŸ·è¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ å–å¾—æœ€æ–°ç¨‹å¼ç¢¼
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # ç¢ºä¿æˆ‘å€‘æ‰‹å‹•è¨­å®š GITHUB_TOKEN

      - name: ğŸ”„ æ›¿æ› API_URL
        run: |
          find . -type f \( -name "*.js" -o -name "*.html" \) | while read file; do
            sed -i "s|API_URL_PLACEHOLDER|${{ secrets.API_URL }}|g" "$file"
          done

      - name: âœ… ç¢ºèª API_URL æ›¿æ›æ˜¯å¦æˆåŠŸ
        run: grep -r "API_URL_PLACEHOLDER" . || echo "âœ… API_URL æ›¿æ›æˆåŠŸï¼"

      - name: ğŸ“¤ æ¨é€è®Šæ›´åˆ° GitHub
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "ğŸš€ è‡ªå‹•æ›¿æ› API_URL" || echo "âœ… ç„¡è®Šæ›´å¯æäº¤"
          git push origin main || echo "âœ… ç„¡éœ€æ¨é€"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
